@model IEnumerable<CampusIssueReporting.Models.Issue>
@inject Microsoft.AspNetCore.Identity.SignInManager<CampusIssueReporting.Models.ApplicationUser> SignInManager
@{
    ViewData["Title"] = "Issue Feed";
    var sortBy = ViewData["SortBy"] as string ?? "latest";
    var totalCount = (int?)ViewData["TotalCount"] ?? 0;
    var initialCount = Model?.Count() ?? 0;
}

<div class="row">
    <div class="col-lg-9">
        <div class="mb-4">
            <h4 class="mb-2">Campus Issue Reporting</h4>
            <p class="text-muted mb-0">
                Report and track campus issues. Browse reported issues, add comments, and help improve our campus community.
            </p>
        </div>

        <div id="issues-container">
            @await Html.PartialAsync("_IssueCard", Model)
        </div>

        <div id="loading-indicator" class="text-center py-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <div class="col-lg-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">Sort By</h6>
                <select id="sortSelect" class="form-select form-select-sm">
                    <option value="latest" selected="@(sortBy == "latest")">Latest First</option>
                    <option value="oldest" selected="@(sortBy == "oldest")">Oldest First</option>
                </select>
            </div>
        </div>
    </div>
</div>

@* Modal gallery *@
<div class="modal fade" id="issueImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-0">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="issueImageCarousel" class="carousel slide" data-bs-ride="false">
                    <div class="carousel-inner" id="issueImageCarouselInner"></div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#issueImageCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#issueImageCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function() {
            let skip = @initialCount;
            let loading = false;
            let hasMore = @(initialCount < totalCount ? "true" : "false");
            const sortBy = '@sortBy';
            const totalCount = @totalCount;

            // Image gallery
            function populateAndShow(images, startIndex) {
                const inner = document.getElementById('issueImageCarouselInner');
                inner.innerHTML = '';
                images.forEach((img, i) => {
                    const div = document.createElement('div');
                    div.className = 'carousel-item' + (i === startIndex ? ' active' : '');
                    const imgEl = document.createElement('img');
                    imgEl.src = img;
                    imgEl.className = 'd-block w-100';
                    imgEl.style.maxHeight = '75vh';
                    imgEl.style.objectFit = 'contain';
                    div.appendChild(imgEl);
                    inner.appendChild(div);
                });
                const carouselEl = document.getElementById('issueImageCarousel');
                let carousel = bootstrap.Carousel.getInstance(carouselEl);
                if (carousel) carousel.dispose();
                carousel = new bootstrap.Carousel(carouselEl, { interval: false, wrap: false });
                carousel.to(startIndex);
                const modal = new bootstrap.Modal(document.getElementById('issueImageModal'));
                modal.show();
            }

            document.addEventListener('click', function(e) {
                const thumb = e.target.closest('.issue-thumb');
                if (!thumb) return;
                e.preventDefault();
                try {
                    const images = JSON.parse(thumb.getAttribute('data-images') || '[]');
                    const start = parseInt(thumb.getAttribute('data-start') || '0');
                    if (images.length) populateAndShow(images, Math.min(start, images.length - 1));
                } catch (err) {
                    console.error('Failed to open gallery', err);
                }
            });

            // Toggle comments - use event delegation
            document.addEventListener('click', function(e) {
                if (e.target.closest('.toggle-comments')) {
                    const btn = e.target.closest('.toggle-comments');
                    const content = btn.closest('.comments-section').querySelector('.comments-content');
                    const icon = btn.querySelector('.fa-chevron-down, .fa-chevron-up');
                    if (content.style.display === 'none' || !content.style.display) {
                        content.style.display = 'block';
                        if (icon) {
                            icon.classList.remove('fa-chevron-down');
                            icon.classList.add('fa-chevron-up');
                        }
                    } else {
                        content.style.display = 'none';
                        if (icon) {
                            icon.classList.remove('fa-chevron-up');
                            icon.classList.add('fa-chevron-down');
                        }
                    }
                }
            });

            // Sort dropdown
            document.getElementById('sortSelect').addEventListener('change', function() {
                window.location.href = '/Issue?sortBy=' + this.value;
            });

            // Infinite scroll
            function loadMore() {
                if (loading || !hasMore) return;
                if (skip >= totalCount) {
                    hasMore = false;
                    return;
                }
                
                loading = true;
                document.getElementById('loading-indicator').style.display = 'block';

                fetch(`/Issue/LoadMore?skip=${skip}&take=10&sortBy=${sortBy}`)
                    .then(response => response.text())
                    .then(html => {
                        const trimmed = html.trim();
                        if (trimmed && !trimmed.includes('No more issues')) {
                            document.getElementById('issues-container').insertAdjacentHTML('beforeend', trimmed);
                            const loadedCount = (trimmed.match(/data-issue-id/g) || []).length;
                            skip += loadedCount;
                            if (skip >= totalCount || loadedCount < 10) {
                                hasMore = false;
                            }
                        } else {
                            hasMore = false;
                        }
                        loading = false;
                        document.getElementById('loading-indicator').style.display = 'none';
                    })
                    .catch(err => {
                        console.error('Failed to load more', err);
                        loading = false;
                        hasMore = false;
                        document.getElementById('loading-indicator').style.display = 'none';
                    });
            }

            window.addEventListener('scroll', function() {
                if (hasMore && window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
                    loadMore();
                }
            });
        })();
    </script>
}
